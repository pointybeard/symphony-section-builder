#!/usr/bin/env php
<?php

declare(strict_types=1);

/*
 * This file is part of the "Symphony CMS: Section Builder" repository.
 *
 * Copyright 2018-2020 Alannah Kearney <hi@alannahkearney.com>
 *
 * For the full copyright and license information, please view the LICENCE
 * file that was distributed with this source code.
 */

if (false == defined('PHP_VERSION_ID') || PHP_VERSION_ID < 70300) {
    fwrite(STDERR, "section-builder requires PHP 7.3.0 or newer.".PHP_EOL);
    exit(254);
}

set_error_handler(static function ($severity, $message, $file, $line) {
    if ($severity & error_reporting()) {
        throw new ErrorException($message, 0, $severity, $file, $line);
    }
});

// This might be run from a couple of different locations. Traverse up the folder
// structure looking for vendor/autoload.php or autoload.php and stop if
// its not found after AUTOLOAD_SEARCH_LIMIT iterations.
define("AUTOLOAD_SEARCH_LIMIT", 4);
$current = 0;
$autoload = null;
while($current < AUTOLOAD_SEARCH_LIMIT) {
    $location = __DIR__ . str_repeat("/..", $current);
    foreach([$location . '/vendor/', $location] as $path) {
        $autoload = $path . '/autoload.php';
        if(true == file_exists($autoload)) {
            break 2;
        }
    }
    $current++;
}

if(null == $autoload) {
    throw new RuntimeException('ERROR: Unable to locate Composer autoload.php');
}

require_once $autoload;

use pointybeard\Helpers\Functions\Cli;
use pointybeard\Symphony\SectionBuilder;
use pointybeard\Symphony\SectionBuilder\Includes\Functions;

/*
Check if we're running as root and if so, mention to the user its not a great idea
*/
if (true == Cli\is_su()) {
    Functions\output('It is not a good idea to run this script as root. Consider using a non-root user.', Functions\OUTPUT_WARNING);
    Functions\ask_to_proceed();
}

exit((new SectionBuilder\Application())->run());
